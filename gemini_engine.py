import google.generativeai as genai
import config
import time
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API
genai.configure(api_key=config.TOKEN_GEMINI) # –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ config.py –∫–ª—é—á –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è TOKEN_GEMINI

# –°–ü–ò–°–û–ö –†–ê–ó–†–ï–®–ï–ù–ù–´–• –ö–ê–¢–ï–ì–û–†–ò–ô (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ø–∞–ø–∫–∞–º–∏)
VALID_CATEGORIES = [
    "alkohol", "snacky", "syry", "maso", "klobasa_sunka_salam_parky",
    "ovoce_a_zelenina", "pecivo", "cistidla", "nadobi", "kava_caj", 
    "general", "info"
]

# –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø (–¢–û–¢ –°–ê–ú–´–ô –ú–û–ó–ì)
SYSTEM_PROMPT = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ—Ä—á–µ–Ω–¥–∞–π–∑–µ—Ä —á–µ—à—Å–∫–∏—Ö —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–æ–≤ (Albert, Tesco).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.

–û—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –û–î–ù–ò–ú –°–õ–û–í–û–ú –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞:
- alkohol (–≤–∏–Ω–æ, –ø–∏–≤–æ, –∫—Ä–µ–ø–∫–∏–π –∞–ª–∫–æ–≥–æ–ª—å, –Ω–∞–ø–∏—Ç–∫–∏, –≤–æ–¥–∞)
- snacky (—á–∏–ø—Å—ã, –æ—Ä–µ—Ö–∏, —Å—É—Ö–∞—Ä–∏–∫–∏, —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç—ã)
- syry (—Å—ã—Ä, –±—Ä—ã–Ω–∑–∞, —Ç–≤–æ—Ä–æ–≥, –º–æ–ª–æ–∫–æ)
- maso (—Å—ã—Ä–æ–µ –º—è—Å–æ, —Å—Ç–µ–π–∫–∏, —Ñ–∞—Ä—à, –∫—É—Ä–∏—Ü–∞)
- klobasa_sunka_salam_parky (–∫–æ–ª–±–∞—Å–∞, –≤–µ—Ç—á–∏–Ω–∞, —Å–æ—Å–∏—Å–∫–∏, —Å–∞–ª—è–º–∏, –ø–∞—à—Ç–µ—Ç—ã)
- ovoce_a_zelenina (–æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –≥—Ä–∏–±—ã)
- pecivo (—Ö–ª–µ–±, –±—É–ª–æ—á–∫–∏, –ø–æ–Ω—á–∏–∫–∏)
- cistidla (–±—ã—Ç–æ–≤–∞—è —Ö–∏–º–∏—è, –ø–æ—Ä–æ—à–∫–∏, —É–±–æ—Ä–∫–∞, –∑—É–±–Ω—ã–µ –ø–∞—Å—Ç—ã –∏ –ø–æ–ª–æ—Å–∫–∞–ª–∫–∏, –≥–µ–ª–∏ –∏ —à–∞–º–ø—É–Ω–∏, –¥–µ–∑–æ–¥–æ—Ä–∞–Ω—Ç—ã, –ø—Ä–æ–∫–ª–∞–¥–∫–∏, –ø–∞–º–ø–µ—Ä—Å—ã)
- nadobi (–ø–æ—Å—É–¥–∞, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫—É—Ö–Ω—è)
- kava_caj (–∫–æ—Ñ–µ, —á–∞–π, —à–æ–∫–æ–ª–∞–¥, –∫–æ–Ω—Ñ–µ—Ç—ã)
- info (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ä–µ–∫–ª–∞–º–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
- general (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –∏–ª–∏ —Å–º–µ—à–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã)

–ù–ï –ø–∏—à–∏ –Ω–∏–∫–∞–∫–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π. –ù–ï —Å—Ç–∞–≤—å –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è. –¢–û–õ–¨–ö–û –ö–û–î –ö–ê–¢–ï–ì–û–†–ò–ò.
"""

def analyze_image(image_path):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ Gemini Flash –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
    """
    print(f"üß† Gemini —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞: {os.path.basename(image_path)}...")
    
    try:
        # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ –æ–±–ª–∞–∫–æ Gemini (—ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è Vision –º–æ–¥–µ–ª–µ–π)
        myfile = genai.upload_file(image_path)
        
        # 2. –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å (Flash - —Å–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è)
        # –ï—Å–ª–∏ API —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ –º–æ–¥–µ–ª—å, –ø–æ–ø—Ä–æ–±—É–π 'gemini-1.5-flash-latest'
        model = genai.GenerativeModel(
            model_name="gemini-1.5-flash", 
            system_instruction=SYSTEM_PROMPT
        )

        # 3. –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
        # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 0.1 –¥–µ–ª–∞–µ—Ç –æ—Ç–≤–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º (–±–µ–∑ —Ñ–∞–Ω—Ç–∞–∑–∏–π)
        response = model.generate_content(
            [myfile, "–ö–∞–∫–∞—è —ç—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è?"],
            generation_config={"temperature": 0.1}
        )
        
        # 4. –ß–∏—Å—Ç–∏–º –æ—Ç–≤–µ—Ç –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –º—É—Å–æ—Ä–∞
        result = response.text.strip().lower()
        
        # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å
        if result in VALID_CATEGORIES:
            return result
        else:
            print(f"‚ö†Ô∏è Gemini –ø—Ä–∏–¥—É–º–∞–ª–∞ —á—Ç–æ-—Ç–æ —Å–≤–æ–µ: '{result}'. –°–∫–∏–¥—ã–≤–∞—é –≤ general.")
            return "general"

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ Gemini: {e}")
        # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏–ª–∏ –ª–∏–º–∏—Ç—ã), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º general, —á—Ç–æ–±—ã –Ω–µ —Å—Ç–æ–ø–æ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
        return "general"

if __name__ == "__main__":
    # –¢–µ—Å—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∞–º–æ–≥–æ —Ñ–∞–π–ª–∞
    print("–¢–µ—Å—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å...")
    # –¢—É—Ç –º–æ–∂–µ—à—å –≤–ø–∏—Å–∞—Ç—å –ø—É—Ç—å –∫ —Ä–µ–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    # print(analyze_image("temp_images/test.jpg"))